var I=Object.defineProperty;var f=Object.getOwnPropertySymbols;var b=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable;var v=(d,e,t)=>e in d?I(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t,o=(d,e)=>{for(var t in e||(e={}))b.call(e,t)&&v(d,t,e[t]);if(f)for(var t of f(e))C.call(e,t)&&v(d,t,e[t]);return d};import{ApplicationInsights as T}from"@microsoft/applicationinsights-web";import*as i from"vscode";function h(){return globalThis.telemetryOutputChannel===void 0&&(globalThis.telemetryOutputChannel=i.window.createOutputChannel("Log (Extension Telemetry)")),globalThis.telemetryOutputChannel}var m=class{constructor(e,t,n,s,r){this.extensionId=e;this.extensionVersion=t;this.telemetryAppender=n;this.osShim=s;this.firstParty=!1;this.userOptIn=!1;this.firstParty=!!r,this.updateUserOptStatus(),i.env.onDidChangeTelemetryEnabled!==void 0?this.optOutListener=i.env.onDidChangeTelemetryEnabled(()=>this.updateUserOptStatus()):this.optOutListener=i.workspace.onDidChangeConfiguration(()=>this.updateUserOptStatus())}updateUserOptStatus(){let e=i.workspace.getConfiguration(m.TELEMETRY_CONFIG_ID),t=i.env.isTelemetryEnabled===void 0?e.get(m.TELEMETRY_CONFIG_ENABLED_ID,!0):i.env.isTelemetryEnabled;this.userOptIn!==t&&(this.userOptIn=t)}cleanRemoteName(e){if(!e)return"none";let t="other";return["ssh-remote","dev-container","attached-container","wsl"].forEach(n=>{e.indexOf(`${n}+`)===0&&(t=n)}),t}get extension(){return this._extension===void 0&&(this._extension=i.extensions.getExtension(this.extensionId)),this._extension}cloneAndChange(e,t){if(e===null||typeof e!="object"||typeof t!="function")return e;let n={};for(let s in e)n[s]=t(s,e[s]);return n}shouldSendErrorTelemetry(){return this.firstParty?this.cleanRemoteName(i.env.remoteName)!=="other"?!0:!(this.extension===void 0||this.extension.extensionKind===i.ExtensionKind.Workspace||i.env.uiKind===i.UIKind.Web):!0}getCommonProperties(){let e=Object.create(null);if(e["common.os"]=this.osShim.platform,e["common.platformversion"]=(this.osShim.release||"").replace(/^(\d+)(\.\d+)?(\.\d+)?(.*)/,"$1$2$3"),e["common.extname"]=this.extensionId,e["common.extversion"]=this.extensionVersion,i&&i.env){switch(e["common.vscodemachineid"]=i.env.machineId,e["common.vscodesessionid"]=i.env.sessionId,e["common.vscodeversion"]=i.version,e["common.isnewappinstall"]=i.env.isNewAppInstall,i.env.uiKind){case i.UIKind.Web:e["common.uikind"]="web";break;case i.UIKind.Desktop:e["common.uikind"]="desktop";break;default:e["common.uikind"]="unknown"}e["common.remotename"]=this.cleanRemoteName(i.env.remoteName)}return e}anonymizeFilePaths(e,t){let n;if(e==null)return"";let s=[];i.env.appRoot!==""&&s.push(new RegExp(i.env.appRoot.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi")),this.extension&&s.push(new RegExp(this.extension.extensionPath.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"));let r=e;if(t){let a=[];for(let c of s)for(;(n=c.exec(e))&&n;)a.push([n.index,c.lastIndex]);let p=/^[\\/]?(node_modules|node_modules\.asar)[\\/]/,g=/(file:\/\/)?([a-zA-Z]:(\\\\|\\|\/)|(\\\\|\\|\/))?([\w-._]+(\\\\|\\|\/))+[\w-._]*/g,u=0;for(r="";(n=g.exec(e))&&n;)n[0]&&!p.test(n[0])&&a.every(([c,E])=>n.index<c||n.index>=E)&&(r+=e.substring(u,n.index)+"<REDACTED: user-file-path>",u=g.lastIndex);u<e.length&&(r+=e.substr(u))}for(let a of s)r=r.replace(a,"");return r}sendTelemetryEvent(e,t,n){if(this.userOptIn&&e!==""){t=o(o({},t),this.getCommonProperties());let s=this.cloneAndChange(t,(r,a)=>this.anonymizeFilePaths(a,this.firstParty));this.telemetryAppender.logEvent(`${this.extensionId}/${e}`,{properties:s,measurements:n}),h().appendLine(`${this.extensionId}/${e} ${JSON.stringify({properties:s,measurements:n})}`)}}sendTelemetryErrorEvent(e,t,n,s){if(this.userOptIn&&e!==""){t=o(o({},t),this.getCommonProperties());let r=this.cloneAndChange(t,(a,p)=>this.shouldSendErrorTelemetry()?this.anonymizeFilePaths(p,this.firstParty):s===void 0||s.indexOf(a)!==-1?"REDACTED":this.anonymizeFilePaths(p,this.firstParty));this.telemetryAppender.logEvent(`${this.extensionId}/${e}`,{properties:r,measurements:n}),h().appendLine(`${this.extensionId}/${e} ${JSON.stringify({properties:r,measurements:n})}`)}}sendTelemetryException(e,t,n){if(this.shouldSendErrorTelemetry()&&this.userOptIn&&e){t=o(o({},t),this.getCommonProperties());let s=this.cloneAndChange(t,(r,a)=>this.anonymizeFilePaths(a,this.firstParty));this.telemetryAppender.logException(e,{properties:s,measurements:n}),h().appendLine(`${this.extensionId}/${e.name} ${JSON.stringify({properties:s,measurements:n})}`)}}dispose(){return this.telemetryAppender.flush(),this.optOutListener.dispose()}},l=m;l.TELEMETRY_CONFIG_ID="telemetry",l.TELEMETRY_CONFIG_ENABLED_ID="enableTelemetry";var y=class{constructor(e){let t;e&&e.indexOf("AIF-")===0&&(t="https://vortex.data.microsoft.com/collect/v1"),this._aiClient=new T({config:{instrumentationKey:e,endpointUrl:t,disableAjaxTracking:!0,disableExceptionTracking:!0,disableFetchTracking:!0,disableCorrelationHeaders:!0,disableCookiesUsage:!0,autoTrackPageVisitTime:!1,emitLineDelimitedJson:!0}}),this._aiClient.loadAppInsights(),t&&fetch(t).catch(()=>this._aiClient=void 0)}logEvent(e,t){!this._aiClient||this._aiClient.trackEvent({name:e},o(o({},t.properties),t.measurements))}logException(e,t){!this._aiClient||this._aiClient.trackException({exception:e,properties:o(o({},t.properties),t.measurements)})}flush(){return this._aiClient&&(this._aiClient.flush(),this._aiClient=void 0),Promise.resolve(void 0)}},x=class extends l{constructor(e,t,n,s){let r=new y(n);n&&n.indexOf("AIF-")===0&&(s=!0),super(e,t,r,{release:navigator.appVersion,platform:"web"},s)}};export{x as default};
