var P=Object.create;var d=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames,E=Object.getOwnPropertySymbols,w=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable;var _=(s,e,t)=>e in s?d(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,p=(s,e)=>{for(var t in e||(e={}))O.call(e,t)&&_(s,t,e[t]);if(E)for(var t of E(e))D.call(e,t)&&_(s,t,e[t]);return s};var T=s=>d(s,"__esModule",{value:!0});var R=(s,e)=>{T(s);for(var t in e)d(s,t,{get:e[t],enumerable:!0})},L=(s,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $(e))!O.call(s,n)&&n!=="default"&&d(s,n,{get:()=>e[n],enumerable:!(t=k(e,n))||t.enumerable});return s},g=s=>L(T(d(s!=null?P(w(s)):{},"default",s&&s.__esModule&&"default"in s?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0})),s);R(exports,{default:()=>I});var v=g(require("os")),y=g(require("vscode")),l=g(require("applicationinsights"));var i=g(require("vscode"));function x(){return globalThis.telemetryOutputChannel===void 0&&(globalThis.telemetryOutputChannel=i.window.createOutputChannel("Log (Extension Telemetry)")),globalThis.telemetryOutputChannel}var f=class{constructor(e,t,n,r,o){this.extensionId=e;this.extensionVersion=t;this.telemetryAppender=n;this.osShim=r;this.firstParty=!1;this.userOptIn=!1;this.firstParty=!!o,this.updateUserOptStatus(),i.env.onDidChangeTelemetryEnabled!==void 0?this.optOutListener=i.env.onDidChangeTelemetryEnabled(()=>this.updateUserOptStatus()):this.optOutListener=i.workspace.onDidChangeConfiguration(()=>this.updateUserOptStatus())}updateUserOptStatus(){let e=i.workspace.getConfiguration(f.TELEMETRY_CONFIG_ID),t=i.env.isTelemetryEnabled===void 0?e.get(f.TELEMETRY_CONFIG_ENABLED_ID,!0):i.env.isTelemetryEnabled;this.userOptIn!==t&&(this.userOptIn=t)}cleanRemoteName(e){if(!e)return"none";let t="other";return["ssh-remote","dev-container","attached-container","wsl"].forEach(n=>{e.indexOf(`${n}+`)===0&&(t=n)}),t}get extension(){return this._extension===void 0&&(this._extension=i.extensions.getExtension(this.extensionId)),this._extension}cloneAndChange(e,t){if(e===null||typeof e!="object"||typeof t!="function")return e;let n={};for(let r in e)n[r]=t(r,e[r]);return n}shouldSendErrorTelemetry(){return this.firstParty?this.cleanRemoteName(i.env.remoteName)!=="other"?!0:!(this.extension===void 0||this.extension.extensionKind===i.ExtensionKind.Workspace||i.env.uiKind===i.UIKind.Web):!0}getCommonProperties(){let e=Object.create(null);if(e["common.os"]=this.osShim.platform,e["common.platformversion"]=(this.osShim.release||"").replace(/^(\d+)(\.\d+)?(\.\d+)?(.*)/,"$1$2$3"),e["common.extname"]=this.extensionId,e["common.extversion"]=this.extensionVersion,i&&i.env){switch(e["common.vscodemachineid"]=i.env.machineId,e["common.vscodesessionid"]=i.env.sessionId,e["common.vscodeversion"]=i.version,e["common.isnewappinstall"]=i.env.isNewAppInstall,i.env.uiKind){case i.UIKind.Web:e["common.uikind"]="web";break;case i.UIKind.Desktop:e["common.uikind"]="desktop";break;default:e["common.uikind"]="unknown"}e["common.remotename"]=this.cleanRemoteName(i.env.remoteName)}return e}anonymizeFilePaths(e,t){let n;if(e==null)return"";let r=[];i.env.appRoot!==""&&r.push(new RegExp(i.env.appRoot.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi")),this.extension&&r.push(new RegExp(this.extension.extensionPath.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"));let o=e;if(t){let a=[];for(let m of r)for(;(n=m.exec(e))&&n;)a.push([n.index,m.lastIndex]);let h=/^[\\/]?(node_modules|node_modules\.asar)[\\/]/,C=/(file:\/\/)?([a-zA-Z]:(\\\\|\\|\/)|(\\\\|\\|\/))?([\w-._]+(\\\\|\\|\/))+[\w-._]*/g,u=0;for(o="";(n=C.exec(e))&&n;)n[0]&&!h.test(n[0])&&a.every(([m,A])=>n.index<m||n.index>=A)&&(o+=e.substring(u,n.index)+"<REDACTED: user-file-path>",u=C.lastIndex);u<e.length&&(o+=e.substr(u))}for(let a of r)o=o.replace(a,"");return o}sendTelemetryEvent(e,t,n){if(this.userOptIn&&e!==""){t=p(p({},t),this.getCommonProperties());let r=this.cloneAndChange(t,(o,a)=>this.anonymizeFilePaths(a,this.firstParty));this.telemetryAppender.logEvent(`${this.extensionId}/${e}`,{properties:r,measurements:n}),x().appendLine(`${this.extensionId}/${e} ${JSON.stringify({properties:r,measurements:n})}`)}}sendTelemetryErrorEvent(e,t,n,r){if(this.userOptIn&&e!==""){t=p(p({},t),this.getCommonProperties());let o=this.cloneAndChange(t,(a,h)=>this.shouldSendErrorTelemetry()?this.anonymizeFilePaths(h,this.firstParty):r===void 0||r.indexOf(a)!==-1?"REDACTED":this.anonymizeFilePaths(h,this.firstParty));this.telemetryAppender.logEvent(`${this.extensionId}/${e}`,{properties:o,measurements:n}),x().appendLine(`${this.extensionId}/${e} ${JSON.stringify({properties:o,measurements:n})}`)}}sendTelemetryException(e,t,n){if(this.shouldSendErrorTelemetry()&&this.userOptIn&&e){t=p(p({},t),this.getCommonProperties());let r=this.cloneAndChange(t,(o,a)=>this.anonymizeFilePaths(a,this.firstParty));this.telemetryAppender.logException(e,{properties:r,measurements:n}),x().appendLine(`${this.extensionId}/${e.name} ${JSON.stringify({properties:r,measurements:n})}`)}}dispose(){return this.telemetryAppender.flush(),this.optOutListener.dispose()}},c=f;c.TELEMETRY_CONFIG_ID="telemetry",c.TELEMETRY_CONFIG_ENABLED_ID="enableTelemetry";var b=class{constructor(e){l.defaultClient?(this._appInsightsClient=new l.TelemetryClient(e),this._appInsightsClient.channel.setUseDiskRetryCaching(!0)):(l.setup(e).setAutoCollectRequests(!1).setAutoCollectPerformance(!1).setAutoCollectExceptions(!1).setAutoCollectDependencies(!1).setAutoDependencyCorrelation(!1).setAutoCollectConsole(!1).setUseDiskRetryCaching(!0).start(),this._appInsightsClient=l.defaultClient),y&&y.env&&(this._appInsightsClient.context.tags[this._appInsightsClient.context.keys.userId]=y.env.machineId,this._appInsightsClient.context.tags[this._appInsightsClient.context.keys.sessionId]=y.env.sessionId),e&&e.indexOf("AIF-")===0&&(this._appInsightsClient.config.endpointUrl="https://vortex.data.microsoft.com/collect/v1")}logEvent(e,t){!this._appInsightsClient||this._appInsightsClient.trackEvent({name:e,properties:t.properties,measurements:t.measurements})}logException(e,t){!this._appInsightsClient||this._appInsightsClient.trackException({exception:e,properties:t.properties,measurements:t.measurements})}flush(){return this._appInsightsClient&&(this._appInsightsClient.flush(),this._appInsightsClient=void 0),Promise.resolve(void 0)}},I=class extends c{constructor(e,t,n,r){let o=new b(n);n&&n.indexOf("AIF-")===0&&(r=!0),super(e,t,o,{release:v.release(),platform:v.platform()},r)}};0&&(module.exports={});
